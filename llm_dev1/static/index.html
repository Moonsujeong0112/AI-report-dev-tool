<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI RAG Prompt Test</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🤖</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-900 min-h-screen p-6">
    <div class="max-w-4xl mx-auto bg-white shadow-md rounded-xl p-8">
      <div class="flex justify-between items-start mb-6">
        <h1 class="text-3xl font-bold text-indigo-600">🤖 실시간 RAG 프롬프트 테스트</h1>

        <!-- Usage Dashboard -->
        <div id="usageStats" class="bg-gray-100 text-sm text-right rounded-md p-3 shadow-inner min-w-[200px]">
          <div><strong>총 요청:</strong> <span id="totalRequests">-</span></div>
          <div><strong>입력 토큰:</strong> <span id="totalTokensInput">-</span></div>
          <div><strong>출력 토큰:</strong> <span id="totalTokensOutput">-</span></div>
          <div><strong>총 비용:</strong> $<span id="totalCost">-</span></div>
        </div>
      </div>

      <form id="ragForm" class="space-y-6">
        <div>
          <label class="block font-semibold mb-1">문제 메타데이터</label>
          <textarea name="metadata" rows="5" class="w-full p-3 border rounded-md"></textarea>
        </div>

        <div>
          <label class="block font-semibold mb-1">채팅 기록</label>
          <textarea name="chat_log" rows="10" class="w-full p-3 border rounded-md"></textarea>
        </div>

        <div>
          <label class="block font-semibold mb-1">오답 판별 기준 (RAG)</label>
          <textarea name="rag_criteria" rows="10" class="w-full p-3 border rounded-md"></textarea>
        </div>

        <div>
          <label class="block font-semibold mb-1">학습자 입력</label>
          <textarea name="user_input" rows="10" class="w-full p-3 border rounded-md"></textarea>
        </div>

        <div class="flex gap-6">
          <div class="flex-1">
            <label class="block font-semibold mb-1">창의성 (Temperature)</label>
            <input type="number" name="temperature" min="0" max="2" step="0.1" value="0.7" class="w-full p-2 border rounded-md" />
          </div>
          <div class="flex-1">
            <label class="block font-semibold mb-1">최대 토큰</label>
            <input type="number" name="max_tokens" min="100" max="10000" value="5000" class="w-full p-2 border rounded-md" />
          </div>
        </div>

        <div>
          <button type="submit" id="submitButton" class="w-full py-3 px-6 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700">
            🧪 RAG 테스트 실행
          </button>
        </div>
      </form>

      <!-- Loading -->
      <div id="loadingBox" class="mt-6 hidden text-center text-indigo-600 font-semibold">
        ⏳ 리포트 생성 중입니다...
      </div>

      <!-- 결과 출력 -->
      <div id="result" class="mt-10 hidden">
        <h2 class="text-xl font-bold mb-4 text-gray-700">📄 결과</h2>
        <p class="mb-2"><strong>응답:</strong> <span id="responseText" class="text-gray-800"></span></p>
        <p class="mb-2"><strong>입력 토큰:</strong> <span id="inputTokens" class="text-green-600"></span></p>
        <p class="mb-2"><strong>출력 토큰:</strong> <span id="outputTokens" class="text-green-600"></span></p>
        <p class="mb-4"><strong>비용:</strong> <span id="cost" class="text-red-600"></span></p>
        <details class="bg-gray-100 rounded-md p-4">
          <summary class="font-semibold cursor-pointer">📝 전체 프롬프트 보기</summary>
          <pre id="promptBox" class="mt-3 whitespace-pre-wrap"></pre>
        </details>
      </div>

      <!-- Chat History 버튼 -->
      <div class="text-right mt-10">
        <button onclick="openChatHistoryModal()" class="px-4 py-2 text-sm bg-slate-100 border rounded hover:bg-slate-200">
          📖 이전 내역 보기
        </button>
      </div>
    </div>

    <!-- Chat History Modal -->
    <div id="chatModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
      <div class="bg-white w-full max-w-3xl max-h-[80vh] overflow-y-auto rounded shadow-lg p-6 relative">
        <button onclick="closeChatHistoryModal()" class="absolute top-2 right-3 text-gray-500 hover:text-black text-xl font-bold">&times;</button>
        <h2 class="text-xl font-semibold mb-4 text-indigo-600">📜 첫테기 기록</h2>
        <pre id="chatHistoryContent" class="whitespace-pre-wrap text-sm text-gray-800"></pre>
      </div>
    </div>

    <script>
      async function loadUsageStats() {
        const res = await fetch("/api/stats");
        const stats = await res.json();
        document.getElementById("totalRequests").innerText = stats.total_requests;
        document.getElementById("totalTokensInput").innerText = stats.total_tokens_input;
        document.getElementById("totalTokensOutput").innerText = stats.total_tokens_output;
        document.getElementById("totalCost").innerText = stats.total_cost.toFixed(6);
      }

      async function openChatHistoryModal() {
        const modal = document.getElementById("chatModal");
        const content = document.getElementById("chatHistoryContent");
        try {
          const res = await fetch("/api/history");
          const history = await res.json();
          const formatted = history.map((item, i) => `\n🟢 [${i + 1}]\n👤 사용자: ${item.user_message?.slice(0, 300) || "(없음)"}\n🤖 응답: ${item.assistant_message?.slice(0, 300) || "(없음)"}\n🧮 토큰: ${item.tokens_used}, 비용: $${item.cost}`).join("\n\n");
          content.textContent = formatted;
        } catch (err) {
          content.textContent = "❌ 채팅 기록을 불러오는 중 오류가 발생했습니다.";
        }
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }

      function closeChatHistoryModal() {
        const modal = document.getElementById("chatModal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }

      document.getElementById("ragForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const loadingBox = document.getElementById("loadingBox");
        const submitButton = document.getElementById("submitButton");
        loadingBox?.classList.remove("hidden");
        submitButton.disabled = true;

        try {
          const response = await fetch("/rag-test", {
            method: "POST",
            body: formData
          });
          const result = await response.json();
          if (response.ok) {
            document.getElementById("result").classList.remove("hidden");
            document.getElementById("responseText").innerText = result.response;
            document.getElementById("inputTokens").innerText = result.tokens_input;
            document.getElementById("outputTokens").innerText = result.tokens_output;
            document.getElementById("cost").innerText = `$${result.cost}`;
            document.getElementById("promptBox").innerText = result.prompt;
          } else {
            alert(result.error || "RAG 테스트 중 오류가 발생했습니다.");
          }

          await loadUsageStats(); // ✅ 실시간 통계 갱신

        } catch (err) {
          alert("서버 오류 또는 네트워크 오류가 발생했습니다.");
        } finally {
          loadingBox?.classList.add("hidden");
          submitButton.disabled = false;
        }
      });

      // ⏱️ 자동 통계 갱신
      setInterval(loadUsageStats, 10000);
      window.addEventListener("DOMContentLoaded", loadUsageStats);
    </script>
  </body>
</html>
