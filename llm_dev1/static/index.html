<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI RAG Prompt Test</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¤–</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 text-gray-900 min-h-screen p-6">
    <div class="max-w-4xl mx-auto bg-white shadow-md rounded-xl p-8">
      <div class="flex justify-between items-start mb-6">
        <h1 class="text-3xl font-bold text-indigo-600">ğŸ¤– ì‹¤ì‹œê°„ RAG í”„ë¡¬í”„íŠ¸ í…ŒìŠ¤íŠ¸</h1>

        <!-- Usage Dashboard -->
        <div id="usageStats" class="bg-gray-100 text-sm text-right rounded-md p-3 shadow-inner min-w-[200px]">
          <div><strong>ì´ ìš”ì²­:</strong> <span id="totalRequests">-</span></div>
          <div><strong>ì…ë ¥ í† í°:</strong> <span id="totalTokensInput">-</span></div>
          <div><strong>ì¶œë ¥ í† í°:</strong> <span id="totalTokensOutput">-</span></div>
          <div><strong>ì´ ë¹„ìš©:</strong> $<span id="totalCost">-</span></div>
        </div>
      </div>

      <form id="ragForm" class="space-y-6">
        <div>
          <label class="block font-semibold mb-1">ë¬¸ì œ ë©”íƒ€ë°ì´í„°</label>
          <textarea name="metadata" rows="5" class="w-full p-3 border rounded-md"></textarea>
        </div>

        <div>
          <label class="block font-semibold mb-1">ì±„íŒ… ê¸°ë¡</label>
          <textarea name="chat_log" rows="10" class="w-full p-3 border rounded-md"></textarea>
        </div>

        <div>
          <label class="block font-semibold mb-1">ì˜¤ë‹µ íŒë³„ ê¸°ì¤€ (RAG)</label>
          <textarea name="rag_criteria" rows="10" class="w-full p-3 border rounded-md"></textarea>
        </div>

        <div>
          <label class="block font-semibold mb-1">í•™ìŠµì ì…ë ¥</label>
          <textarea name="user_input" rows="10" class="w-full p-3 border rounded-md"></textarea>
        </div>

        <div class="flex gap-6">
          <div class="flex-1">
            <label class="block font-semibold mb-1">ì°½ì˜ì„± (Temperature)</label>
            <input type="number" name="temperature" min="0" max="2" step="0.1" value="0.7" class="w-full p-2 border rounded-md" />
          </div>
          <div class="flex-1">
            <label class="block font-semibold mb-1">ìµœëŒ€ í† í°</label>
            <input type="number" name="max_tokens" min="100" max="10000" value="5000" class="w-full p-2 border rounded-md" />
          </div>
        </div>

        <div>
          <button type="submit" id="submitButton" class="w-full py-3 px-6 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700">
            ğŸ§ª RAG í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          </button>
        </div>
      </form>

      <!-- Loading -->
      <div id="loadingBox" class="mt-6 hidden text-center text-indigo-600 font-semibold">
        â³ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...
      </div>

      <!-- ê²°ê³¼ ì¶œë ¥ -->
      <div id="result" class="mt-10 hidden">
        <h2 class="text-xl font-bold mb-4 text-gray-700">ğŸ“„ ê²°ê³¼</h2>
        <p class="mb-2"><strong>ì‘ë‹µ:</strong> <span id="responseText" class="text-gray-800"></span></p>
        <p class="mb-2"><strong>ì…ë ¥ í† í°:</strong> <span id="inputTokens" class="text-green-600"></span></p>
        <p class="mb-2"><strong>ì¶œë ¥ í† í°:</strong> <span id="outputTokens" class="text-green-600"></span></p>
        <p class="mb-4"><strong>ë¹„ìš©:</strong> <span id="cost" class="text-red-600"></span></p>
        <details class="bg-gray-100 rounded-md p-4">
          <summary class="font-semibold cursor-pointer">ğŸ“ ì „ì²´ í”„ë¡¬í”„íŠ¸ ë³´ê¸°</summary>
          <pre id="promptBox" class="mt-3 whitespace-pre-wrap"></pre>
        </details>
      </div>

      <!-- Chat History ë²„íŠ¼ -->
      <div class="text-right mt-10">
        <button onclick="openChatHistoryModal()" class="px-4 py-2 text-sm bg-slate-100 border rounded hover:bg-slate-200">
          ğŸ“– ì´ì „ ë‚´ì—­ ë³´ê¸°
        </button>
      </div>
    </div>

    <!-- Chat History Modal -->
    <div id="chatModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
      <div class="bg-white w-full max-w-3xl max-h-[80vh] overflow-y-auto rounded shadow-lg p-6 relative">
        <button onclick="closeChatHistoryModal()" class="absolute top-2 right-3 text-gray-500 hover:text-black text-xl font-bold">&times;</button>
        <h2 class="text-xl font-semibold mb-4 text-indigo-600">ğŸ“œ ì²«í…Œê¸° ê¸°ë¡</h2>
        <pre id="chatHistoryContent" class="whitespace-pre-wrap text-sm text-gray-800"></pre>
      </div>
    </div>

    <script>
      async function loadUsageStats() {
        const res = await fetch("/api/stats");
        const stats = await res.json();
        document.getElementById("totalRequests").innerText = stats.total_requests;
        document.getElementById("totalTokensInput").innerText = stats.total_tokens_input;
        document.getElementById("totalTokensOutput").innerText = stats.total_tokens_output;
        document.getElementById("totalCost").innerText = stats.total_cost.toFixed(6);
      }

      async function openChatHistoryModal() {
        const modal = document.getElementById("chatModal");
        const content = document.getElementById("chatHistoryContent");
        try {
          const res = await fetch("/api/history");
          const history = await res.json();
          const formatted = history.map((item, i) => `\nğŸŸ¢ [${i + 1}]\nğŸ‘¤ ì‚¬ìš©ì: ${item.user_message?.slice(0, 300) || "(ì—†ìŒ)"}\nğŸ¤– ì‘ë‹µ: ${item.assistant_message?.slice(0, 300) || "(ì—†ìŒ)"}\nğŸ§® í† í°: ${item.tokens_used}, ë¹„ìš©: $${item.cost}`).join("\n\n");
          content.textContent = formatted;
        } catch (err) {
          content.textContent = "âŒ ì±„íŒ… ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        }
        modal.classList.remove("hidden");
        modal.classList.add("flex");
      }

      function closeChatHistoryModal() {
        const modal = document.getElementById("chatModal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      }

      document.getElementById("ragForm").addEventListener("submit", async function (e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const loadingBox = document.getElementById("loadingBox");
        const submitButton = document.getElementById("submitButton");
        loadingBox?.classList.remove("hidden");
        submitButton.disabled = true;

        try {
          const response = await fetch("/rag-test", {
            method: "POST",
            body: formData
          });
          const result = await response.json();
          if (response.ok) {
            document.getElementById("result").classList.remove("hidden");
            document.getElementById("responseText").innerText = result.response;
            document.getElementById("inputTokens").innerText = result.tokens_input;
            document.getElementById("outputTokens").innerText = result.tokens_output;
            document.getElementById("cost").innerText = `$${result.cost}`;
            document.getElementById("promptBox").innerText = result.prompt;
          } else {
            alert(result.error || "RAG í…ŒìŠ¤íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }

          await loadUsageStats(); // âœ… ì‹¤ì‹œê°„ í†µê³„ ê°±ì‹ 

        } catch (err) {
          alert("ì„œë²„ ì˜¤ë¥˜ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
          loadingBox?.classList.add("hidden");
          submitButton.disabled = false;
        }
      });

      // â±ï¸ ìë™ í†µê³„ ê°±ì‹ 
      setInterval(loadUsageStats, 10000);
      window.addEventListener("DOMContentLoaded", loadUsageStats);
    </script>
  </body>
</html>
